import { useState, useCallback } from "react";

const MODEL = "claude-sonnet-4-20250514";
const CONTRACT_TYPES = ["Auto-detect", "Lease", "SaaS Agreement", "Employment Contract", "Other"];

const STYLES = `
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: #0F1115; color: #E8EAF0; }
  ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #1A1D24; } ::-webkit-scrollbar-thumb { background: #2E3240; border-radius: 3px; }

  .app { min-height: 100vh; background: #0F1115; padding: 48px 24px 80px; }
  .container { max-width: 760px; margin: 0 auto; }

  /* Header */
  .header { text-align: center; margin-bottom: 56px; }
  .logo { display: inline-flex; align-items: center; gap: 10px; margin-bottom: 24px; }
  .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, #C9A84C, #F0D080); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; box-shadow: 0 0 20px rgba(201,168,76,0.3); }
  .logo-name { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; background: linear-gradient(135deg, #E8D5A3, #C9A84C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header h1 { font-size: 42px; font-weight: 800; letter-spacing: -1.5px; color: #F0F1F5; line-height: 1.1; margin-bottom: 14px; }
  .header h1 span { background: linear-gradient(135deg, #C9A84C, #F0D080); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header p { font-size: 16px; color: #6B7080; font-weight: 400; max-width: 460px; margin: 0 auto; line-height: 1.6; }

  /* Upload Card */
  .card { background: #1A1D24; border-radius: 20px; border: 1px solid #23272F; box-shadow: 0 8px 40px rgba(0,0,0,0.4); padding: 32px; margin-bottom: 16px; }

  .dropzone { border: 1.5px dashed #2E3240; border-radius: 16px; padding: 52px 24px; text-align: center; cursor: pointer; transition: all 0.2s ease; position: relative; background: #14171E; }
  .dropzone:hover, .dropzone.over { border-color: #C9A84C; background: rgba(201,168,76,0.04); box-shadow: 0 0 0 4px rgba(201,168,76,0.06); }
  .dropzone-icon { font-size: 32px; margin-bottom: 14px; display: block; }
  .dropzone-title { font-size: 15px; font-weight: 600; color: #C8CAD4; margin-bottom: 6px; }
  .dropzone-sub { font-size: 13px; color: #4A4F5E; }
  .file-loaded { display: flex; flex-direction: column; align-items: center; gap: 6px; }
  .file-name { font-size: 15px; font-weight: 600; color: #E8D5A3; }
  .file-size { font-size: 12px; color: #5A6070; }

  .row { display: flex; align-items: center; gap: 12px; margin-top: 20px; }
  .label { font-size: 13px; color: #6B7080; font-weight: 500; white-space: nowrap; }
  select { flex: 1; background: #14171E; border: 1px solid #23272F; color: #C8CAD4; font-size: 13px; padding: 10px 14px; border-radius: 10px; outline: none; font-family: 'Inter', sans-serif; cursor: pointer; transition: border-color 0.2s; appearance: none; }
  select:focus { border-color: #C9A84C; }

  .btn-primary { width: 100%; background: linear-gradient(135deg, #B8962E, #E0C060); color: #0F1115; font-size: 14px; font-weight: 700; padding: 14px; border-radius: 12px; border: none; cursor: pointer; margin-top: 20px; transition: all 0.2s ease; letter-spacing: 0.2px; font-family: 'Inter', sans-serif; box-shadow: 0 4px 20px rgba(201,168,76,0.25); }
  .btn-primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 30px rgba(201,168,76,0.4); filter: brightness(1.05); }
  .btn-primary:disabled { background: #23272F; color: #4A4F5E; cursor: not-allowed; box-shadow: none; transform: none; }

  .btn-ghost { width: 100%; background: transparent; border: 1px solid #23272F; color: #6B7080; font-size: 13px; font-weight: 500; padding: 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s; font-family: 'Inter', sans-serif; margin-top: 16px; }
  .btn-ghost:hover { border-color: #3A3F50; color: #9CA3AF; background: #1A1D24; }

  .error { background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); color: #F87171; font-size: 13px; padding: 12px 16px; border-radius: 10px; margin-top: 16px; }

  /* Loading */
  .loading { text-align: center; padding: 80px 0; }
  .spinner { width: 44px; height: 44px; border: 2px solid #23272F; border-top-color: #C9A84C; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 20px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-title { font-size: 18px; font-weight: 600; color: #C8CAD4; margin-bottom: 6px; }
  .loading-sub { font-size: 14px; color: #4A4F5E; }

  /* Results */
  .summary-card { background: linear-gradient(135deg, #1A1D24, #1E2130); border-radius: 20px; border: 1px solid #2A2E3A; padding: 32px; margin-bottom: 24px; box-shadow: 0 8px 40px rgba(0,0,0,0.4); }
  .summary-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; margin-bottom: 20px; }
  .contract-label { font-size: 11px; color: #4A4F5E; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 6px; }
  .contract-type { font-size: 26px; font-weight: 800; color: #F0F1F5; letter-spacing: -0.5px; }
  .contract-parties { font-size: 13px; color: #6B7080; margin-top: 4px; }
  .risk-badge { padding: 8px 18px; border-radius: 100px; font-size: 12px; font-weight: 700; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; }
  .risk-badge.high { background: rgba(239,68,68,0.12); color: #F87171; border: 1px solid rgba(239,68,68,0.2); }
  .risk-badge.medium { background: rgba(245,158,11,0.12); color: #FBBF24; border: 1px solid rgba(245,158,11,0.2); }
  .risk-badge.low { background: rgba(52,211,153,0.12); color: #6EE7B7; border: 1px solid rgba(52,211,153,0.2); }
  .summary-text { font-size: 14px; color: #8B90A0; line-height: 1.7; padding-bottom: 24px; border-bottom: 1px solid #23272F; margin-bottom: 24px; }
  .stats { display: flex; gap: 12px; }
  .stat { flex: 1; background: #14171E; border-radius: 12px; padding: 16px; text-align: center; border: 1px solid #1E2130; }
  .stat-num { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
  .stat-num.high { color: #F87171; }
  .stat-num.medium { color: #FBBF24; }
  .stat-num.low { color: #6EE7B7; }
  .stat-label { font-size: 11px; color: #4A4F5E; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; }

  /* Clause section */
  .section-title { font-size: 11px; color: #4A4F5E; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .section-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .section-dot.high { background: #F87171; box-shadow: 0 0 6px rgba(248,113,113,0.6); }
  .section-dot.medium { background: #FBBF24; box-shadow: 0 0 6px rgba(251,191,36,0.6); }
  .section-dot.low { background: #6EE7B7; box-shadow: 0 0 6px rgba(110,231,183,0.6); }

  .clause { background: #1A1D24; border-radius: 14px; border: 1px solid #23272F; margin-bottom: 8px; overflow: hidden; transition: border-color 0.2s; }
  .clause:hover { border-color: #2E3240; }
  .clause.open { border-color: #2E3240; }
  .clause-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; cursor: pointer; gap: 12px; }
  .clause-left { display: flex; align-items: flex-start; gap: 12px; flex: 1; min-width: 0; }
  .clause-dot { width: 7px; height: 7px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
  .clause-dot.high { background: #F87171; }
  .clause-dot.medium { background: #FBBF24; }
  .clause-dot.low { background: #6EE7B7; }
  .clause-name { font-size: 14px; font-weight: 600; color: #D0D3DE; margin-bottom: 3px; }
  .clause-summary { font-size: 12px; color: #4A4F5E; line-height: 1.5; }
  .clause-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  .mini-badge { font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 100px; letter-spacing: 0.5px; text-transform: uppercase; }
  .mini-badge.high { background: rgba(239,68,68,0.1); color: #F87171; }
  .mini-badge.medium { background: rgba(245,158,11,0.1); color: #FBBF24; }
  .mini-badge.low { background: rgba(52,211,153,0.1); color: #6EE7B7; }
  .chevron { color: #4A4F5E; font-size: 10px; transition: transform 0.2s; }
  .chevron.open { transform: rotate(180deg); }

  .clause-body { padding: 0 20px 20px; border-top: 1px solid #1E2130; }
  .clause-section { margin-top: 16px; }
  .clause-section-label { font-size: 10px; color: #4A4F5E; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
  .clause-section-label span { font-size: 12px; }
  blockquote { font-size: 12px; color: #6B7080; font-style: italic; background: #14171E; border-left: 2px solid #C9A84C; padding: 10px 14px; border-radius: 0 8px 8px 0; line-height: 1.6; }
  .body-text { font-size: 13px; color: #8B90A0; line-height: 1.7; }
  .redline { font-size: 12px; color: #6EE7B7; background: rgba(52,211,153,0.06); border: 1px solid rgba(52,211,153,0.15); padding: 10px 14px; border-radius: 8px; font-family: 'SF Mono', 'Fira Code', monospace; line-height: 1.6; }

  /* Missing clauses */
  .missing-card { background: rgba(96,165,250,0.04); border: 1px solid rgba(96,165,250,0.12); border-radius: 16px; padding: 24px; margin-bottom: 20px; }
  .missing-title { font-size: 13px; font-weight: 700; color: #93C5FD; margin-bottom: 12px; display: flex; align-items: center; gap-8px; }
  .missing-item { font-size: 13px; color: #6B7080; padding: 5px 0; border-bottom: 1px solid rgba(96,165,250,0.06); display: flex; align-items: center; gap: 8px; }
  .missing-item:last-child { border-bottom: none; }

  .disclaimer { text-align: center; font-size: 11px; color: #2E3240; margin-top: 40px; }
`;

function ClauseCard({ clause }) {
  const [open, setOpen] = useState(false);
  const lv = clause.risk_level;
  return (
    <div className={`clause${open ? " open" : ""}`}>
      <div className="clause-header" onClick={() => setOpen(!open)}>
        <div className="clause-left">
          <div className={`clause-dot ${lv}`} />
          <div>
            <div className="clause-name">{clause.clause_name}</div>
            <div className="clause-summary">{clause.summary}</div>
          </div>
        </div>
        <div className="clause-right">
          <span className={`mini-badge ${lv}`}>{lv}</span>
          <span className={`chevron${open ? " open" : ""}`}>‚ñº</span>
        </div>
      </div>
      {open && (
        <div className="clause-body">
          {clause.original_text && (
            <div className="clause-section">
              <div className="clause-section-label"><span>üìå</span> Original Text</div>
              <blockquote>"{clause.original_text}"</blockquote>
            </div>
          )}
          <div className="clause-section">
            <div className="clause-section-label"><span>üí°</span> Why It Matters</div>
            <div className="body-text">{clause.explanation}</div>
          </div>
          {clause.benchmark && (
            <div className="clause-section">
              <div className="clause-section-label"><span>üìä</span> Market Benchmark</div>
              <div className="body-text">{clause.benchmark}</div>
            </div>
          )}
          {clause.negotiation_tip && (
            <div className="clause-section">
              <div className="clause-section-label"><span>‚ö°</span> Negotiation Leverage</div>
              <div className="body-text">{clause.negotiation_tip}</div>
            </div>
          )}
          {clause.suggested_language && (
            <div className="clause-section">
              <div className="clause-section-label"><span>‚úèÔ∏è</span> Suggested Redline</div>
              <div className="redline">{clause.suggested_language}</div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

export default function App() {
  const [file, setFile] = useState(null);
  const [contractType, setContractType] = useState("Auto-detect");
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  const [dragOver, setDragOver] = useState(false);

  const handleFile = f => {
    if (f && (f.type === "application/pdf" || f.type === "text/plain" || f.name.endsWith(".txt") || f.name.endsWith(".pdf"))) {
      setFile(f); setResult(null); setError(null);
    } else {
      setError("Please upload a PDF or TXT file.");
    }
  };

  const onDrop = useCallback(e => {
    e.preventDefault(); setDragOver(false);
    handleFile(e.dataTransfer.files[0]);
  }, []);

  const analyze = async () => {
    if (!file) return;
    setLoading(true); setError(null);
    try {
      const toBase64 = f => new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result.split(",")[1]);
        r.onerror = rej;
        r.readAsDataURL(f);
      });
      const isPdf = file.type === "application/pdf";
      let messages;
      if (isPdf) {
        const b64 = await toBase64(file);
        messages = [{ role: "user", content: [{ type: "document", source: { type: "base64", media_type: "application/pdf", data: b64 } }, { type: "text", text: buildPrompt(contractType) }] }];
      } else {
        const text = await file.text();
        messages = [{ role: "user", content: `${buildPrompt(contractType)}\n\n---CONTRACT TEXT---\n${text}` }];
      }
      const res = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ model: MODEL, max_tokens: 4000, messages })
      });
      const data = await res.json();
      const raw = data.content?.map(b => b.text || "").join("");
      const parsed = JSON.parse(raw.replace(/```json|```/g, "").trim());
      setResult(parsed);
    } catch (e) {
      setError("Analysis failed. " + e.message);
    } finally {
      setLoading(false);
    }
  };

  const byRisk = lv => result?.clauses?.filter(c => c.risk_level === lv) || [];

  return (
    <>
      <style>{STYLES}</style>
      <div className="app">
        <div className="container">

          <div className="header">
            <div className="logo">
              <div className="logo-icon">‚öñ</div>
              <span className="logo-name">ContractIQ</span>
            </div>
            <h1>Know what you're<br /><span>signing.</span></h1>
            <p>Upload any contract and get instant risk analysis, market benchmarks, and negotiation leverage ‚Äî in plain English.</p>
          </div>

          {!result && !loading && (
            <div className="card">
              <div
                className={`dropzone${dragOver ? " over" : ""}`}
                onDragOver={e => { e.preventDefault(); setDragOver(true); }}
                onDragLeave={() => setDragOver(false)}
                onDrop={onDrop}
                onClick={() => document.getElementById("fi").click()}
              >
                <input id="fi" type="file" accept=".pdf,.txt" style={{display:"none"}} onChange={e => handleFile(e.target.files[0])} />
                {file ? (
                  <div className="file-loaded">
                    <span style={{fontSize:28}}>üìé</span>
                    <div className="file-name">{file.name}</div>
                    <div className="file-size">{(file.size/1024).toFixed(1)} KB ¬∑ ready to analyze</div>
                  </div>
                ) : (
                  <>
                    <span className="dropzone-icon">üìÑ</span>
                    <div className="dropzone-title">Drop your contract here</div>
                    <div className="dropzone-sub">Supports PDF & TXT ¬∑ Lease, SaaS, Employment, or any agreement</div>
                  </>
                )}
              </div>

              <div className="row">
                <span className="label">Contract type</span>
                <select value={contractType} onChange={e => setContractType(e.target.value)}>
                  {CONTRACT_TYPES.map(t => <option key={t}>{t}</option>)}
                </select>
              </div>

              {error && <div className="error">{error}</div>}

              <button className="btn-primary" disabled={!file || loading} onClick={analyze}>
                Analyze Contract ‚Üí
              </button>
            </div>
          )}

          {loading && (
            <div className="loading">
              <div className="spinner" />
              <div className="loading-title">Analyzing your contract‚Ä¶</div>
              <div className="loading-sub">Identifying risky clauses and benchmarking against standard terms</div>
            </div>
          )}

          {result && !loading && (
            <>
              <div className="summary-card">
                <div className="summary-top">
                  <div>
                    <div className="contract-label">Contract Type</div>
                    <div className="contract-type">{result.contract_type || contractType}</div>
                    {result.parties && <div className="contract-parties">{result.parties}</div>}
                  </div>
                  <div className={`risk-badge ${result.overall_risk?.toLowerCase()}`}>
                    {result.overall_risk} Risk
                  </div>
                </div>
                {result.summary && <div className="summary-text">{result.summary}</div>}
                <div className="stats">
                  {[["high","üî¥"],["medium","üü°"],["low","üü¢"]].map(([lv, icon]) => (
                    <div className="stat" key={lv}>
                      <div className={`stat-num ${lv}`}>{byRisk(lv).length}</div>
                      <div className="stat-label">{lv} risk</div>
                    </div>
                  ))}
                </div>
              </div>

              {["high","medium","low"].map(lv => {
                const clauses = byRisk(lv);
                if (!clauses.length) return null;
                return (
                  <div key={lv} style={{marginBottom:32}}>
                    <div className="section-title">
                      <div className={`section-dot ${lv}`} />
                      {lv} risk ¬∑ {clauses.length} clause{clauses.length !== 1 ? "s" : ""}
                    </div>
                    {clauses.map((c,i) => <ClauseCard key={i} clause={c} />)}
                  </div>
                );
              })}

              {result.missing_clauses?.length > 0 && (
                <div className="missing-card">
                  <div className="missing-title">‚ö†Ô∏è &nbsp;Missing Standard Clauses</div>
                  {result.missing_clauses.map((m,i) => (
                    <div className="missing-item" key={i}>
                      <span style={{color:"#3B82F6"}}>‚Ä∫</span> {m}
                    </div>
                  ))}
                </div>
              )}

              <button className="btn-ghost" onClick={() => { setResult(null); setFile(null); }}>
                ‚Üê Analyze another contract
              </button>
            </>
          )}

          <div className="disclaimer">Not legal advice. Consult a qualified attorney before signing any agreement.</div>
        </div>
      </div>
    </>
  );
}

function buildPrompt(contractType) {
  return `You are an expert contract attorney. Analyze this ${contractType === "Auto-detect" ? "contract" : contractType} and return ONLY a JSON object (no markdown, no preamble).

{
  "contract_type": "detected type",
  "parties": "e.g. Between Acme Corp and Jane Doe",
  "overall_risk": "High | Medium | Low",
  "summary": "2-3 sentence plain-English overview and main concerns",
  "clauses": [
    {
      "clause_name": "short name",
      "risk_level": "high | medium | low",
      "summary": "one sentence",
      "original_text": "brief quote max 100 words",
      "explanation": "plain English what this means for the signing party",
      "benchmark": "how this compares to standard market terms",
      "negotiation_tip": "specific leverage or ask",
      "suggested_language": "optional replacement language"
    }
  ],
  "missing_clauses": ["standard clauses absent from this contract"]
}

Find ALL significant clauses (8-15). Prioritize unusual, one-sided, or risky terms. Be specific and actionable.`;
}
